# Webpack

## webpack运行机制

### 基本流程

1. 初始化配置参数

2. 绑定事件钩子回调

3. 确定Entry逐一遍历

4. 使用loader编译文件

5. 输出文件

## 事件流

*Webpack 就像一条生产线，要经过一系列**处理流程**后才能将源文件转换成输出结果。*

*这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。*

*插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。 Webpack 通过  **Tapable** 来组织这条复杂的生产线。 Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件 —— 吴浩麟《深入浅出webpack》*

#### 读取配置

读取命令行传入的配置以及项目里的 webpack.config.js 文件，拿到初始化构建的配置参数对象；

执行plugins插件选项语句，生成Compiler传入plugin的apply方法，为webpack事件流挂上自定义钩子。将Compiler传入plugin的apply方法，webpack事件流挂上自定义钩子。

读取配置的Entries，递归遍历所有的入口文件

#### 入口文件

**loader**

从一个入口文件开始，用户配置好的loader对文件内容进行编译（buildModule）；

**compilation**

对编译后文件内容使用acorn解析生成AST静态语法树（normalModuleLoader），AST是webpack操作的基础对象；

以入口文件为根，进行依赖分析，对所有深度的模块重复上一步；

最后将所有模块中的require语法替换成__webpack_require__来模拟模块化操作（浏览器环境下按需加载和执行模块）。

#### emit

资源输出阶段，从 `compilation.assets` 拿到要输出的资源文件及其内容，Webpack 会遍历这些资源并逐个写入到指定目录。

## AST

抽象语法树，源代码语法结构的一种抽象表示（树结构）；编译必会涉及的东西；

转换成AST的目的就是将我们书写的字符串文件转换成计算机更容易识别的数据结构，这样更容易提取其中的关键信息，而这棵树在计算机上的表现形式，其实就是一个单纯的Object。

## 输出结果解析

**webpack_require**方法

## 编写plugin

本质是是一个带有apply方法的class，将在初始化配置时被调用，添加到工作流；

只需监听事件流各处理即可（compiler.hooks.run.tap即监听run处理时）；

常用事件流：

- **apply**：插件的入口函数

- **compilation**：新的编译过程开始时触发，支持在编译过程中操作模块、修改资源、生成新的代码块等

- **emit**：所有资源准备好并即将输出；支持修改生成的资源

- **done**：构建完成触发

## 编写loader

webpack真正起编译作用的便是我们的loader；

loader只是一个普通的funciton，他会传入匹配到的文件内容(String)，你只需要对这些字符串做些处理输出字符串；

**loader实战**

- 使用 `loader-utils` 拿到用户自定义的loaderr配置

- `this.callback` 方法导出内容

- 执行顺序对 `use` 选项从后向前，依次出栈

- loader导出的 **pitch** 函数内处理，将先于所有loader执行

## webpack5更新

- **持久化缓存（Persistent Caching）** 
  Webpack 5 引入了文件系统级别的持久化缓存功能，这使得在多次构建时可以缓存结果，大幅减少二次构建的时间，尤其适合大型项目。这相比 Webpack 4 的内存缓存方式，有了显著提升。

- **模块联邦（Module Federation）** 
  模块联邦是 Webpack 5 的一个重要特性，它允许多个独立的应用或微前端共享模块，打破传统打包工具中各应用独立打包的模式，使共享模块变得更加简单灵活，支持跨应用的模块共享。

- **自动清理未使用代码（Tree Shaking）改进** 
  Webpack 5 在 Tree Shaking 上做了显著优化，支持更好地处理深层嵌套的模块、动态导入等情况，提高了对未使用代码的检测和清理效果，从而进一步减小打包体积。

- **内置多进程并行打包** 
  Webpack 5 增加了对多线程和 Worker 的支持，优化了构建速度，减少了构建过程中等待和阻塞的情况，尤其适合构建任务较重的项目。

- **更好的代码分割和预加载** 
  Webpack 5 改进了代码分割逻辑，默认支持动态导入并可以更好地处理异步模块分割。同时，提供了更细粒度的控制，使开发者可以根据应用场景更高效地加载资源。

- **优化后的文件大小和打包性能** 
  Webpack 5 对资源管理和生成的 bundle 进行了优化，通过更高效的算法和资源处理方式，打包体积进一步减小，性能显著提升。

- 
